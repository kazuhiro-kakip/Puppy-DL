#ifndef STEP46_H
#define STEP46_H

#include "pdl_core.h"
#include "util/svg_writer.h"

//
void step46()
{
    using namespace pdl;
    auto model = MLP<double>("MLP", {10,1});
    auto optimizer = new Optimizer(&model);

    NArr<double> nx ({{0.5488135},{0.71518937},{0.60276338},{0.54488318},{0.4236548 },{0.64589411},{0.43758721},{0.891773  },{0.96366276},{0.38344152},{0.79172504},{0.52889492},{0.56804456},{0.92559664},{0.07103606},{0.0871293 },{0.0202184 },{0.83261985},{0.77815675},{0.87001215},{0.97861834},{0.79915856},{0.46147936},{0.78052918},{0.11827443},{0.63992102},{0.14335329},{0.94466892},{0.52184832},{0.41466194},{0.26455561},{0.77423369},{0.45615033},{0.56843395},{0.0187898 },{0.6176355 },{0.61209572},{0.616934  },{0.94374808},{0.6818203 },{0.3595079 },{0.43703195},{0.6976312 },{0.06022547},{0.66676672},{0.67063787},{0.21038256},{0.1289263 },{0.31542835},{0.36371077},{0.57019677},{0.43860151},{0.98837384},{0.10204481},{0.20887676},{0.16130952},{0.65310833},{0.2532916 },{0.46631077},{0.24442559},{0.15896958},{0.11037514},{0.65632959},{0.13818295},{0.19658236},{0.36872517},{0.82099323},{0.09710128},{0.83794491},{0.09609841},{0.97645947},{0.4686512 },{0.97676109},{0.60484552},{0.73926358},{0.03918779},{0.28280696},{0.12019656},{0.2961402 },{0.11872772},{0.31798318},{0.41426299},{0.0641475 },{0.69247212},{0.56660145},{0.26538949},{0.52324805},{0.09394051},{0.5759465 },{0.9292962 },{0.31856895},{0.66741038},{0.13179786},{0.7163272 },{0.28940609},{0.18319136},{0.58651293},{0.02010755},{0.82894003},{0.00469548}});
    NArr<double> ny ({{0.37589817},{-0.70616765},{ 0.13345127},{ 0.68390235},{ 0.71025825},{-0.21742843},{ 0.97421905},{-0.05654912},{-0.00325359},{ 1.62137431},{-0.51870546},{ 0.66585226},{ 0.28484889},{-0.15321017},{ 1.24545824},{ 0.91701694},{ 1.00779772},{-0.28698531},{-0.10265612},{-0.03638478},{ 0.59131312},{-0.45135258},{ 1.19575982},{-0.3376686 },{ 1.10045852},{-0.16380362},{ 0.80296453},{-0.03911964},{ 0.52332724},{ 0.80094617},{ 1.61383628},{-0.5596614 },{ 0.40751718},{-0.11857319},{ 0.68775064},{-0.0827692 },{-0.07318916},{-0.01717709},{ 0.30597489},{-0.47821909},{ 1.66902704},{ 0.75296061},{-0.51048713},{ 1.26136473},{-0.06014556},{-0.17434185},{ 1.06940503},{ 1.64381655},{ 1.63092372},{ 1.75429034},{-0.27744934},{ 1.24440619},{ 0.08950856},{ 1.21369021},{ 1.0906239 },{ 1.69671628},{-0.01302257},{ 1.56888688},{ 0.61728175},{ 1.06855368},{ 1.53826993},{ 1.09278106},{-0.10969174},{ 1.62956814},{ 1.91972354},{ 1.59023174},{-0.89043823},{ 0.93293184},{-0.12118566},{ 0.73940772},{ 0.37366578},{ 0.25003711},{ 0.05450043},{-0.59361802},{-0.20402781},{ 0.46766843},{ 1.32418155},{ 1.61352818},{ 1.66268475},{ 0.71053687},{ 1.07484392},{ 1.13450022},{ 0.96945491},{-0.69748927},{ 0.52785171},{ 1.60929463},{ 0.39007988},{ 1.14647509},{ 0.27084077},{-0.11783137},{ 1.3068399 },{-0.65850864},{ 0.92284781},{-0.03332953},{ 1.70905523},{ 1.40364108},{-0.28978592},{ 0.38036009},{-0.82146654},{ 0.46391489}});

    auto x = variable<double>("x", nx);
    auto y = variable<double>("y", ny);

    auto max_iterator = 10000;

    for(auto i = 0; i < max_iterator; i++)
    {
        auto y_pred = model(x);
        auto loss = mean_squared_error("ms_err", y_pred, y);

        model.cleargrads();
        loss.backward();

        optimizer->update();

        if(i%100==0)
        {
            qDebug() << "no." << i;
            qDebug() << optimizer->fowardText().c_str();
        }
    }

    int size = 100;
    auto x_arr = new double[size];
    for(int i = 0; i < size; i++)
        x_arr[i] = 0.01*i;

    NArr<double> vt(x_arr, 100, 1);
    auto t = variable<double>("t", vt);

    auto y_pred = model(t);

    QColor blue(100,100,255);
    QColor red(255,100,100);

    plot(vt, y_pred.foward(), blue);
    plot(nx, ny, red);
}
#endif // STEP46_H
