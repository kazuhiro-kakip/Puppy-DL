#ifndef STEP42_H
#define STEP42_H

#include "core.h"
#include "util/svg_writer.h"

void step42()
{
    using namespace pdl;
    NArr<double> nx({{0.5488135 },{0.71518937},{0.60276338},{0.54488318},{0.4236548 },{0.64589411},{0.43758721},{0.891773  },{0.96366276},{0.38344152},{0.79172504},{0.52889492},{0.56804456},{0.92559664},{0.07103606},{0.0871293 },{0.0202184 },{0.83261985},{0.77815675},{0.87001215},{0.97861834},{0.79915856},{0.46147936},{0.78052918},{0.11827443},{0.63992102},{0.14335329},{0.94466892},{0.52184832},{0.41466194},{0.26455561},{0.77423369},{0.45615033},{0.56843395},{0.0187898 },{0.6176355 },{0.61209572},{0.616934  },{0.94374808},{0.6818203 },{0.3595079 },{0.43703195},{0.6976312 },{0.06022547},{0.66676672},{0.67063787},{0.21038256},{0.1289263 },{0.31542835},{0.36371077},{0.57019677},{0.43860151},{0.98837384},{0.10204481},{0.20887676},{0.16130952},{0.65310833},{0.2532916 },{0.46631077},{0.24442559},{0.15896958},{0.11037514},{0.65632959},{0.13818295},{0.19658236},{0.36872517},{0.82099323},{0.09710128},{0.83794491},{0.09609841},{0.97645947},{0.4686512 },{0.97676109},{0.60484552},{0.73926358},{0.03918779},{0.28280696},{0.12019656},{0.2961402 },{0.11872772},{0.31798318},{0.41426299},{0.0641475 },{0.69247212},{0.56660145},{0.26538949},{0.52324805},{0.09394051},{0.5759465 },{0.9292962 },{0.31856895},{0.66741038},{0.13179786},{0.7163272 },{0.28940609},{0.18319136},{0.58651293},{0.02010755},{0.82894003},{0.00469548}});
    NArr<double> ny({{6.77544354},{6.70038671},{6.94072077},{7.05195491},{6.09606274},{6.86794556},{6.46721635},{7.35579791},{7.15040715},{6.71963205},{7.03057545},{6.90419851},{6.8355684 },{7.14863023},{5.95586994},{5.57076434},{5.92153999},{7.24651256},{7.43804886},{7.43255589},{7.68249096},{7.09964151},{6.87904236},{7.20504855},{5.6604039 },{6.88623526},{5.30589977},{7.19091265},{6.70387018},{6.11940149},{6.14712665},{6.97723608},{6.04777473},{6.43515022},{5.60754451},{6.82614376},{6.79851669},{6.88706881},{7.53959943},{6.79505903},{6.6155624 },{6.24162578},{6.83112732},{6.0123743 },{7.13972742},{7.04516432},{5.52099201},{6.17733521},{6.345098  },{6.72626855},{6.28984185},{6.74532908},{7.13924061},{5.81964919},{5.5415735 },{6.17062727},{7.11353561},{6.07568394},{6.33980484},{5.55801818},{6.01536794},{5.67429297},{7.03471478},{6.14274823},{6.36868623},{6.59325368},{6.65370054},{5.55418062},{7.40588038},{5.36382649},{7.47395554},{5.99164039},{7.1535187 },{6.22821283},{7.27222486},{5.30230027},{5.91096561},{6.16847442},{6.2966948 },{5.26929437},{5.80066052},{6.45000439},{5.70552358},{6.62283706},{7.06741691},{6.14474494},{6.58212891},{5.777791  },{6.88201502},{7.17053739},{6.03535897},{6.54466451},{5.44978873},{7.3770268 },{6.31836298},{5.85684153},{6.4004405 },{5.29457157},{6.71590922},{5.44380758}});

    auto x = variable<double>("x", nx);
    auto y = variable<double>("y", ny);
    auto W = variable<double>("W", zeros<double>(Shape(1,1)));
    auto b = variable<double>("b", zeros<double>(Shape(1,1)));

    auto lr = 0.1;
    auto iters = 100;

    for(int i = 0; i < iters; i++)
    {
        qDebug() << "no." << QString::number(i);
        auto y_pred = (x*W) + b;
        auto diff = y - y_pred;
        auto sqw = pow("pow", diff, 2);

        double size = diff.length();
        auto loss = sum("sum", sqw) / size;

        W.cleargrad();
        b.cleargrad();
        loss.backward();

        //saveGraph();

        auto dW = W.grad() * lr;
        auto db = b.grad() * lr;
        auto W_new = W.foward() - dW;
        auto b_new = b.foward() - db;

        W.setFoward(W_new);
        b.setFoward(b_new);

        qDebug() << "W:" << W.fowardText().c_str();
        qDebug() << "b:" << b.fowardText().c_str();
        qDebug() << "loss:" << loss.dataText().c_str();
        qDebug() << "--------------------------";
    }
}


#endif // STEP42_H
